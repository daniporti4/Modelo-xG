# -*- coding: utf-8 -*-
"""app_xG.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/155aDzN1xZLSOGu_wgLtDzAxF9Daup2dK
"""


import streamlit as st
import pandas as pd
import numpy as np
import joblib
from xgboost import XGBRegressor
from streamlit_drawable_canvas import st_canvas
from plotly_football_pitch import make_pitch_figure, PitchDimensions, SingleColourBackground

# Cargar modelo y encoder
modelo = joblib.load("modelo_prueba.pkl")
encoder = joblib.load("encoder_ohe.pkl")

st.title("Calculadora de xG")

# Inicializar estado para guardar disparos
if "disparos" not in st.session_state:
    st.session_state.disparos = []

# Columnas categóricas en orden
categorical_cols = [
    'shot_body_part', 'play_pattern', 'under_pressure',
    'shot_one_on_one', 'shot_open_goal', 'shot_aerial_won',
    'shot_first_time', 'shot_deflected', 'shot_technique', 'shot_type'
]

# Columnas numéricas
numeric_cols = ['distance', 'angle']

st.subheader("Haz clic sobre el campo para registrar el disparo")

# Canvas interactivo sin imagen
canvas_result = st_canvas(
    fill_color="red",
    stroke_width=0,
    stroke_color="red",
    background_color="#81B622",
    update_streamlit=True,
    height=470,
    width=700,
    drawing_mode="point",
    key="canvas"
)

# Procesar clic
if canvas_result.json_data and canvas_result.json_data["objects"]:
    punto = canvas_result.json_data["objects"][-1]
    rel_x = punto["left"] / 700
    rel_y = punto["top"] / 470

    # Coordenadas en escala StatsBomb
    x = int(rel_x * 120)
    y = int(rel_y * 80)

    st.success(f"Disparo en X = {x}, Y = {y}")
else:
    st.warning("Haz clic sobre el campo para registrar el disparo.")
    st.stop()

# Selección de opciones
body_part = st.selectbox("Parte del cuerpo", ["Right Foot", "Left Foot", "Head"])
shot_technique = st.selectbox("Técnica", ["Normal", "Volley", "Lob"])
shot_type = st.selectbox("Tipo", ["Open Play", "Free Kick", "From Corner"])
play_pattern = st.selectbox("Patrón de juego", ["Regular Play", "From Counter", "From Throw In"])

# Boleanos
under_pressure = st.checkbox("Bajo presión")
one_on_one = st.checkbox("Uno contra uno")
open_goal = st.checkbox("Portería vacía")
aerial_won = st.checkbox("Remate aéreo ganado")
first_time = st.checkbox("Disparo de primeras")
deflected = st.checkbox("Desviado")

# Cálculo distancia y ángulo
goal_x, goal_y = 120, 40
distance = np.sqrt((goal_x - x)**2 + (goal_y - y)**2)

def calcular_angulo(x, y):
    left_post = np.array([120, 34])
    right_post = np.array([120, 46])
    shot_point = np.array([x, y])
    v1 = left_post - shot_point
    v2 = right_post - shot_point
    cos_angle = np.dot(v1, v2) / (np.linalg.norm(v1) * np.linalg.norm(v2))
    angle_rad = np.arccos(np.clip(cos_angle, -1.0, 1.0))
    return np.degrees(angle_rad)

angle = calcular_angulo(x, y)

# Input para el modelo
input_df = pd.DataFrame([{
    'shot_body_part': body_part,
    'play_pattern': play_pattern,
    'under_pressure': str(under_pressure),
    'shot_one_on_one': str(one_on_one),
    'shot_open_goal': str(open_goal),
    'shot_aerial_won': str(aerial_won),
    'shot_first_time': str(first_time),
    'shot_deflected': str(deflected),
    'shot_technique': shot_technique,
    'shot_type': shot_type
}])

# Codificación + unión con numéricas
X_cat = encoder.transform(input_df)
X_cat_df = pd.DataFrame(X_cat, columns=encoder.get_feature_names_out(), index=input_df.index)
X_num = pd.DataFrame([[distance, angle]], columns=numeric_cols)
X_final = pd.concat([X_num, X_cat_df], axis=1)

# Asegurar columnas modelo
expected_features = modelo.get_booster().feature_names
for col in expected_features:
    if col not in X_final.columns:
        X_final[col] = 0.0
X_final = X_final[expected_features]

# Predicción xG
pred_xg = modelo.predict(X_final)[0]
st.success(f"xG estimado: **{pred_xg:.3f}**")

# Guardar disparo en el historial
st.session_state.disparos.append({"x": x, "y": y, "xG": pred_xg})

# Mostrar todos los disparos
if st.session_state.disparos:
    st.subheader("Disparos realizados")

    df_disp = pd.DataFrame(st.session_state.disparos)

    # Crear campo de fútbol con plotly_football_pitch
    dimensions = PitchDimensions()
    fig = make_pitch_figure(
        dimensions,
        pitch_background=SingleColourBackground("#81B622")  # verde césped
    )

    # Añadir disparos
    fig.add_scatter(
        x=df_disp["x"],
        y=df_disp["y"],
        mode="markers",
        marker=dict(
            size=10 + df_disp["xG"] * 40,
            color=df_disp["xG"],
            colorscale="Reds",
            showscale=True,
            colorbar=dict(title="xG"),
            line=dict(color='black', width=1)
        ),
        hovertemplate="xG: %{marker.color:.2f}<br>X: %{x}, Y: %{y}<extra></extra>",
        name="Disparos"
    )

    st.plotly_chart(fig)
